# 技术架构文档

> 版本：1.0.0
> 更新日期：2026-02-02
> 状态：Phase 1 MVP

---

## 1. 系统架构总览

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            Windows PC                                    │
│  ┌─────────────┐     ┌─────────────────────┐     ┌─────────────────┐   │
│  │             │     │                     │     │                 │   │
│  │  目标应用   │◄────│   AHK 自动化脚本    │────►│  scrcpy 窗口    │   │
│  │  (Word等)   │     │  doubao-bridge.ahk  │     │                 │   │
│  │             │     │                     │     │                 │   │
│  └─────────────┘     └──────────┬──────────┘     └────────┬────────┘   │
│        ▲                        │                         │            │
│        │                        │                         │            │
│        │                   ┌────┴────┐               ┌────┴────┐       │
│        │                   │ 快捷键  │               │  USB    │       │
│        │                   │ 监听    │               │  ADB    │       │
│        │                   └─────────┘               └────┬────┘       │
│        │                                                  │            │
│   ┌────┴────────────────────────────────────────────┐     │            │
│   │              Windows 剪贴板                      │◄────┤            │
│   └─────────────────────────────────────────────────┘     │            │
│                                                           │            │
└───────────────────────────────────────────────────────────┼────────────┘
                                                            │
                            ┌───────────────────────────────┼──────────┐
                            │         Android 手机          │          │
                            │                               ▼          │
                            │  ┌──────────────────────────────────┐   │
                            │  │         scrcpy-server            │   │
                            │  │   (屏幕捕获 + 输入注入 + 剪贴板)   │   │
                            │  └──────────────────────────────────┘   │
                            │                  │                       │
                            │                  ▼                       │
                            │  ┌──────────────────────────────────┐   │
                            │  │       输入容器 App (便签)         │   │
                            │  │   ┌──────────────────────────┐   │   │
                            │  │   │      豆包输入法           │   │   │
                            │  │   │  (语音/AI/智能输入)       │   │   │
                            │  │   └──────────────────────────┘   │   │
                            │  └──────────────────────────────────┘   │
                            │                                          │
                            └──────────────────────────────────────────┘
```

### 1.2 组件职责

| 组件 | 职责 | 技术 |
|------|------|------|
| AHK 脚本 | 快捷键监听、窗口管理、按键发送、流程编排 | AutoHotkey v2.0 |
| scrcpy | 手机投屏、输入转发、剪贴板桥接 | scrcpy 3.3.3 |
| 输入容器 App | 提供文本输入界面 | 小米便签 / Google Keep |
| 豆包输入法 | AI/语音输入能力 | 豆包 App |
| Windows 剪贴板 | 跨进程数据传输 | Win32 API |

---

## 2. 数据流设计

### 2.1 唤起流程数据流

```
用户按键 Alt+Space
         │
         ▼
┌─────────────────┐
│ AHK 键盘钩子    │  捕获全局热键
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 保存当前窗口    │  GetActiveWindow() → LastWindowId
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 查找 scrcpy     │  WinExist("2505APX7BC")
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 激活 & 移动     │  WinActivate() + WinMove()
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 发送清空命令    │  Send("^a{Backspace}")
└─────────────────┘
```

### 2.2 上屏流程数据流

```
用户按键 Ctrl+Enter
         │
         ▼
┌─────────────────┐
│ AHK 条件热键    │  仅在 scrcpy 窗口激活时响应
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│ 发送 Ctrl+A     │────►│ scrcpy 转发     │──► Android 全选
└────────┬────────┘     └─────────────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│ 发送 Ctrl+C     │────►│ scrcpy 转发     │──► Android 复制
└────────┬────────┘     └─────────────────┘
         │                      │
         │                      ▼
         │              ┌─────────────────┐
         │              │ scrcpy 剪贴板   │  自动同步到 PC
         │              │ 同步机制        │
         │              └────────┬────────┘
         │                       │
         ▼                       ▼
┌─────────────────────────────────────────┐
│           Windows 剪贴板                 │
└────────────────────┬────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────┐
│  AHK: 最小化 scrcpy → 激活原窗口 → Ctrl+V │
└─────────────────────────────────────────┘
```

### 2.3 剪贴板同步机制

scrcpy 的剪贴板同步基于以下机制：

```
Android 剪贴板变化
         │
         ▼
┌─────────────────────────┐
│ scrcpy-server 监听      │  ClipboardManager.OnPrimaryClipChangedListener
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ 通过 ADB 隧道发送       │  Socket 通信
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ scrcpy PC 端接收        │  解析协议数据
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ 写入 Windows 剪贴板     │  SetClipboardData()
└─────────────────────────┘
```

**延迟分析**：
- 平均延迟：100-300ms
- 最大延迟：500ms（网络抖动或大量数据）
- AHK 脚本应设置 300ms 等待时间，确保同步完成

---

## 3. AHK 脚本架构

### 3.1 模块划分

```
doubao-bridge.ahk
├── [配置区]           # 可配置参数
│   ├── SCRCPY_TITLE   # scrcpy 窗口标题
│   ├── WIN_WIDTH      # 窗口宽度
│   ├── WIN_HEIGHT     # 窗口高度
│   └── CLIP_WAIT      # 剪贴板等待时间
│
├── [全局变量]
│   └── LastWindowId   # 记录原窗口句柄
│
├── [热键定义]
│   ├── !Space::       # Alt+Space 唤起
│   └── ^Enter::       # Ctrl+Enter 上屏（条件热键）
│
└── [辅助函数]
    ├── ActivateScrcpy()    # 激活并调整窗口
    ├── ClearInputArea()    # 清空输入区
    ├── CopyAndTransfer()   # 复制并传输
    └── RestoreFocus()      # 还原焦点
```

### 3.2 AHK v2.0 代码框架

```autohotkey
#Requires AutoHotkey v2.0
#SingleInstance Force

; ============================================================
; 配置区
; ============================================================
class Config {
    static SCRCPY_TITLE := "2505APX7BC"
    static WIN_WIDTH := 400
    static WIN_HEIGHT := 700
    static CLIP_WAIT_MS := 300
    static KEY_DELAY_MS := 50
}

; ============================================================
; 全局状态
; ============================================================
global LastWindowId := 0

; ============================================================
; 热键：Alt + Space - 唤起
; ============================================================
!Space:: {
    global LastWindowId
    ; 实现逻辑...
}

; ============================================================
; 条件热键：Ctrl + Enter - 上屏（仅 scrcpy 窗口）
; ============================================================
#HotIf WinActive(Config.SCRCPY_TITLE)
^Enter:: {
    global LastWindowId
    ; 实现逻辑...
}
#HotIf
```

---

## 4. 接口设计

### 4.1 AHK 与 Windows API

| 功能 | Win32 API / AHK 函数 |
|------|---------------------|
| 获取当前窗口 | `WinGetID("A")` |
| 查找窗口 | `WinExist(title)` |
| 激活窗口 | `WinActivate(title)` |
| 移动窗口 | `WinMove(title, , x, y, w, h)` |
| 最小化窗口 | `WinMinimize(title)` |
| 发送按键 | `Send("^a")` |
| 等待剪贴板 | `ClipWait(timeout)` |
| 读取剪贴板 | `A_Clipboard` |

### 4.2 scrcpy 参数接口

当前使用的 scrcpy 启动参数：

```bash
scrcpy -K --shortcut-mod=ralt --window-x -1000 --window-y 50 --max-fps 165 -b 20M -w
```

| 参数 | 说明 | 对项目的影响 |
|------|------|-------------|
| `-K` | HID 键盘模式 | Ctrl+A/C 能被正确识别 |
| `--shortcut-mod=ralt` | scrcpy 快捷键用右 Alt | 不与 AHK 热键冲突 |
| `-w` | 保持唤醒 | 手机屏幕常亮 |

**剪贴板相关参数**（默认已启用）：

| 参数 | 说明 |
|------|------|
| `--clipboard-autosync` | 自动双向同步（默认开启） |
| `--no-clipboard-autosync` | 禁用自动同步 |

---

## 5. 文件结构

```
Doubao_win/
├── CLAUDE.md                      # 项目规范
├── docs/                          # 文档目录
│   ├── 00-project-overview.md
│   ├── 01-requirements.md
│   ├── 02-architecture.md         # 本文档
│   ├── 03-development-plan.md
│   └── 04-test-plan.md
├── scripts/                       # 启动脚本
│   ├── start-scrcpy.bat           # 启动 scrcpy
│   ├── stop-scrcpy.bat            # 停止 scrcpy
│   ├── start-ahk.bat              # 启动 AHK 脚本
│   └── stop-ahk.bat               # 停止 AHK 脚本
├── src/                           # 源代码
│   └── ahk/
│       └── doubao-bridge.ahk      # 主脚本
├── config/                        # 配置文件（可选）
│   └── settings.ini               # 用户配置
└── logs/                          # 日志目录
    └── ahk.log                    # AHK 脚本日志
```

---

## 6. 错误处理策略

### 6.1 错误分类

| 错误类型 | 示例 | 严重程度 |
|----------|------|----------|
| 环境错误 | scrcpy 未运行 | 高 |
| 通信错误 | 剪贴板同步失败 | 中 |
| 用户错误 | 原窗口已关闭 | 低 |

### 6.2 错误处理流程

```
错误发生
    │
    ▼
┌─────────────────┐
│ 记录日志        │  时间戳 + 错误类型 + 上下文
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌──────────────┐
│ 可恢复？        │──否─►│ 弹出提示     │
└────────┬────────┘     │ 终止操作     │
         │是            └──────────────┘
         ▼
┌─────────────────┐
│ 执行恢复逻辑    │
│ (重试/降级)     │
└─────────────────┘
```

---

## 7. 安全考虑

| 风险点 | 缓解措施 |
|--------|----------|
| AHK 脚本被杀毒软件拦截 | 添加白名单；使用签名版本 |
| 敏感信息通过剪贴板泄露 | 用户自行注意；不在公共场合使用 |
| USB 调试被恶意利用 | 使用后关闭 USB 调试 |

---

## 8. 扩展性设计

### 8.1 Phase 2 扩展点

| 扩展点 | 说明 |
|--------|------|
| 配置外部化 | 从 INI 文件读取配置 |
| 多设备支持 | 通过设备序列号区分 |
| 窗口样式 | 去边框、透明度调整 |
| 托盘图标 | 状态显示、快捷菜单 |

### 8.2 Phase 3 扩展点

| 扩展点 | 说明 |
|--------|------|
| WebSocket 通信 | 绕过剪贴板，直连传输 |
| 自定义 Android App | 更精细的控制 |
| 模板系统 | 预设文本快速插入 |
