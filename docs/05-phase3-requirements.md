# Phase 3 需求文档：无感输入体验优化

## 1. 概述

### 1.1 背景

Phase 2 实现了基础的 Alt+Space 唤起 + Ctrl+Enter 上屏流程，但用户需要记忆两套快捷键，操作不够流畅。Phase 3 目标是实现「一键触发、自动上屏」的无感体验。

### 1.2 目标

- 简化快捷键：从两个减少到一个
- 自动上屏：无需手动 Ctrl+Enter
- 可视化配置：Web 界面管理设置

### 1.3 核心功能

| 功能 | 优先级 | 描述 |
|------|--------|------|
| 按住触发式快捷键 | P0 | 单一快捷键控制整个流程 |
| 剪贴板监听自动上屏 | P0 | 状态机控制，检测到内容自动粘贴 |
| Web 配置界面 | P1 | 本地 Web 服务，可视化修改设置 |

---

## 2. 功能需求

### 2.1 按住触发式快捷键

#### 2.1.1 需求描述

用户只需记住一个快捷键（默认 `Alt+Space`），通过 Toggle 模式控制输入流程。

#### 2.1.2 交互流程

```
┌─────────────────────────────────────────────────────────┐
│                      状态机流程                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   ┌──────────┐    Alt+Space    ┌──────────────┐        │
│   │          │ ───────────────► │              │        │
│   │  待机态   │                 │   输入态     │        │
│   │  (IDLE)  │ ◄─────────────── │  (ACTIVE)    │        │
│   │          │   Esc/超时/完成   │              │        │
│   └──────────┘                  └──────────────┘        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### 2.1.3 详细行为

**待机态 (IDLE)**：
- 系统正常使用，不干预任何操作
- 监听快捷键 `Alt+Space`

**触发条件 (IDLE → ACTIVE)**：
- 用户按下 `Alt+Space`
- 记录当前活动窗口 ID
- 唤起 scrcpy 窗口并居中
- 启动 Android App
- 清空输入框内容
- 开始监听剪贴板变化

**输入态 (ACTIVE)**：
- scrcpy 窗口前台显示
- 用户在手机上输入内容
- 监听剪贴板变化（用于自动上屏）
- 监听 `Esc` 键（用于取消）
- 监听 `Alt+Space`（用于手动上屏）

**退出条件 (ACTIVE → IDLE)**：

| 触发方式 | 行为 |
|----------|------|
| 剪贴板变化 | 自动切回原窗口 + 粘贴 |
| `Alt+Space` | 手动上屏：复制 + 切回 + 粘贴 |
| `Esc` | 取消输入，直接切回原窗口 |
| 超时 (可配置) | 自动取消，切回原窗口 |
| scrcpy 窗口关闭 | 强制退出输入态 |

#### 2.1.4 配置项

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `hotkey.trigger` | `Alt+Space` | 触发快捷键 |
| `hotkey.cancel` | `Esc` | 取消快捷键 |
| `timeout.active` | `0` (禁用) | 输入态超时时间 (秒) |

---

### 2.2 剪贴板监听自动上屏

#### 2.2.1 需求描述

在输入态下，监听 Windows 剪贴板变化。当检测到内容更新（用户在 App 点击「上屏」），自动执行：切回原窗口 + 粘贴。

#### 2.2.2 状态机控制

**关键设计**：只在输入态 (ACTIVE) 下监听剪贴板，避免干扰日常使用。

```
┌─────────────────────────────────────────────────────┐
│                                                     │
│   IDLE 状态                                         │
│   ┌───────────────────────────────────────────┐    │
│   │  用户复制任何内容 → 完全不干预 ✅          │    │
│   │  剪贴板监听：关闭                          │    │
│   └───────────────────────────────────────────┘    │
│                                                     │
│   ACTIVE 状态                                       │
│   ┌───────────────────────────────────────────┐    │
│   │  剪贴板监听：开启                          │    │
│   │  检测到变化 → 自动切回 + 粘贴              │    │
│   └───────────────────────────────────────────┘    │
│                                                     │
└─────────────────────────────────────────────────────┘
```

#### 2.2.3 防误触机制

| 场景 | 处理方式 |
|------|----------|
| 日常复制 (IDLE) | 不监听，不干预 |
| 输入态复制空内容 | 忽略，不触发上屏 |
| 输入态复制与之前相同内容 | 忽略，不触发上屏 |
| 短时间内多次变化 | 防抖处理，只响应最后一次 |

#### 2.2.4 技术实现

**AHK 方案**：
```autohotkey
OnClipboardChange(ClipboardChanged)

ClipboardChanged(DataType) {
    global State
    if (State != "ACTIVE")
        return  ; 非输入态，忽略

    if (DataType = 1) {  ; 文本内容
        ; 执行自动上屏逻辑
    }
}
```

#### 2.2.5 配置项

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `clipboard.autoSend` | `true` | 是否启用自动上屏 |
| `clipboard.debounceMs` | `200` | 防抖延迟 (毫秒) |
| `clipboard.minLength` | `1` | 最小内容长度，少于此值不触发 |

---

### 2.3 Web 配置界面

#### 2.3.1 需求描述

提供本地 Web 服务，用户通过浏览器访问配置页面，可视化修改设置。

#### 2.3.2 架构设计

```
┌─────────────┐     HTTP      ┌─────────────┐
│   浏览器     │ ◄───────────► │  本地服务    │
│  (前端 UI)  │   localhost   │  (Python)   │
└─────────────┘               └──────┬──────┘
                                     │
                              读写配置文件
                                     │
                              ┌──────▼──────┐
                              │ config.json │
                              └──────┬──────┘
                                     │
                              AHK 脚本读取
                                     │
                              ┌──────▼──────┐
                              │   AHK 脚本   │
                              └─────────────┘
```

#### 2.3.3 配置项清单

**快捷键设置**：
| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `hotkey.trigger` | string | `Alt+Space` | 触发/上屏快捷键 |
| `hotkey.cancel` | string | `Esc` | 取消快捷键 |

**行为设置**：
| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `behavior.autoSend` | boolean | `true` | 剪贴板变化自动上屏 |
| `behavior.autoPaste` | boolean | `true` | 上屏后自动粘贴 |
| `behavior.clearOnActivate` | boolean | `true` | 唤起时清空输入框 |
| `behavior.timeoutSeconds` | number | `0` | 超时时间 (0=禁用) |

**窗口设置**：
| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `window.width` | number | `400` | scrcpy 窗口宽度 |
| `window.height` | number | `700` | scrcpy 窗口高度 |
| `window.position` | string | `center` | 位置: center/remember |

**路径设置**：
| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `path.scrcpy` | string | `C:\scrcpy` | scrcpy 目录 |
| `path.adb` | string | `tools\adb` | ADB 目录 |

**系统设置**：
| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `system.autoStart` | boolean | `false` | 开机自启动 |
| `system.minimizeToTray` | boolean | `true` | 最小化到托盘 |
| `system.language` | string | `zh-CN` | 界面语言 |

#### 2.3.4 Web 界面设计

```
┌──────────────────────────────────────────────────────┐
│  🔧 Doubao Bridge 设置                    [中文 ▼]   │
├──────────────────────────────────────────────────────┤
│                                                      │
│  ⌨️ 快捷键                                           │
│  ┌────────────────────────────────────────────────┐ │
│  │  触发快捷键    [Alt + Space         ] [录制]   │ │
│  │  取消快捷键    [Escape              ] [录制]   │ │
│  └────────────────────────────────────────────────┘ │
│                                                      │
│  ⚡ 行为                                             │
│  ┌────────────────────────────────────────────────┐ │
│  │  ☑ 剪贴板变化自动上屏                          │ │
│  │  ☑ 上屏后自动粘贴到光标位置                    │ │
│  │  ☑ 唤起时清空输入框                            │ │
│  │  超时自动取消  [ 0    ] 秒 (0=禁用)            │ │
│  └────────────────────────────────────────────────┘ │
│                                                      │
│  📐 窗口                                             │
│  ┌────────────────────────────────────────────────┐ │
│  │  宽度 [ 400 ] px    高度 [ 700 ] px            │ │
│  │  位置 (•) 屏幕居中  ( ) 记住上次位置           │ │
│  └────────────────────────────────────────────────┘ │
│                                                      │
│  📁 路径                                             │
│  ┌────────────────────────────────────────────────┐ │
│  │  scrcpy 目录  [C:\scrcpy              ] [浏览] │ │
│  └────────────────────────────────────────────────┘ │
│                                                      │
│  🖥️ 系统                                            │
│  ┌────────────────────────────────────────────────┐ │
│  │  ☐ 开机自动启动                                │ │
│  │  ☑ 关闭时最小化到系统托盘                      │ │
│  └────────────────────────────────────────────────┘ │
│                                                      │
│              [ 恢复默认 ]    [ 保存设置 ]            │
│                                                      │
│  ───────────────────────────────────────────────── │
│  状态: ● 运行中    设备: 2505APX7BC (已连接)        │
│                                                      │
└──────────────────────────────────────────────────────┘
```

#### 2.3.5 API 设计

**基础信息**：
- 服务地址：`http://localhost:23715`
- 数据格式：JSON

**接口列表**：

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/config` | 获取当前配置 |
| PUT | `/api/config` | 更新配置 |
| POST | `/api/config/reset` | 恢复默认配置 |
| GET | `/api/status` | 获取运行状态 |
| POST | `/api/service/restart` | 重启 AHK 服务 |

**配置文件格式** (`config.json`)：
```json
{
  "hotkey": {
    "trigger": "Alt+Space",
    "cancel": "Escape"
  },
  "behavior": {
    "autoSend": true,
    "autoPaste": true,
    "clearOnActivate": true,
    "timeoutSeconds": 0
  },
  "window": {
    "width": 400,
    "height": 700,
    "position": "center"
  },
  "path": {
    "scrcpy": "C:\\scrcpy"
  },
  "system": {
    "autoStart": false,
    "minimizeToTray": true,
    "language": "zh-CN"
  }
}
```

#### 2.3.6 技术选型

| 组件 | 技术 | 说明 |
|------|------|------|
| 后端 | Python + Flask | 轻量级 HTTP 服务 |
| 前端 | HTML + Tailwind CSS + Alpine.js | 无需构建，单文件 |
| 配置存储 | JSON 文件 | 简单可读 |
| 进程通信 | 文件监听 / HTTP | AHK 读取配置变更 |

---

## 3. 用户体验流程

### 3.1 完整使用流程（优化后）

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  1. 首次配置（一次性）                                       │
│     打开浏览器 → localhost:23715 → 配置快捷键和路径          │
│                                                             │
│  2. 日常使用                                                 │
│     ┌─────────────────────────────────────────────────────┐ │
│     │                                                     │ │
│     │   在任意应用按 Alt+Space                            │ │
│     │           │                                         │ │
│     │           ▼                                         │ │
│     │   scrcpy 窗口弹出，手机 App 自动打开                 │ │
│     │           │                                         │ │
│     │           ▼                                         │ │
│     │   使用豆包输入法输入（语音/AI/手写...）              │ │
│     │           │                                         │ │
│     │           ▼                                         │ │
│     │   点击 App「上屏」按钮                               │ │
│     │           │                                         │ │
│     │           ▼                                         │ │
│     │   ✨ 自动返回原窗口 + 内容已粘贴好 ✨                │ │
│     │                                                     │ │
│     └─────────────────────────────────────────────────────┘ │
│                                                             │
│  全程只需：1 个快捷键 + 1 次点击                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 对比

| 操作 | Phase 2 | Phase 3 |
|------|---------|---------|
| 启动 | 手动运行 bat | 开机自启 / 托盘常驻 |
| 唤起 | Alt+Space | Alt+Space |
| 输入 | 手机输入 | 手机输入 |
| 上屏 | 点击按钮 + Ctrl+Enter | 点击按钮（自动完成） |
| 返回 | 手动 | 自动 |
| 粘贴 | 自动 | 自动 |
| **总按键** | **2 个快捷键** | **1 个快捷键** |

---

## 4. 技术实现计划

### 4.1 文件结构

```
Doubao-Bridge/
├── src/
│   ├── ahk/
│   │   ├── doubao-bridge.ahk     # 主脚本（重构）
│   │   ├── lib/
│   │   │   ├── StateMachine.ahk  # 状态机模块
│   │   │   ├── Clipboard.ahk     # 剪贴板监听模块
│   │   │   ├── Config.ahk        # 配置读取模块
│   │   │   └── Tray.ahk          # 托盘图标模块
│   │   └── config.json           # 配置文件
│   │
│   ├── web/
│   │   ├── server.py             # Flask 后端
│   │   ├── static/
│   │   │   └── index.html        # 前端单页面
│   │   └── requirements.txt      # Python 依赖
│   │
│   └── android/                  # (已有)
│
├── scripts/
│   ├── start-all.bat             # 启动全部服务
│   ├── start-web.bat             # 启动 Web 服务
│   └── ...
│
└── ...
```

### 4.2 开发阶段

**阶段 1：状态机 + 快捷键合并** (预计 2-3 小时)
- [ ] 重构 AHK 脚本，实现 IDLE/ACTIVE 状态机
- [ ] 单一快捷键 Toggle 逻辑
- [ ] Esc 取消功能

**阶段 2：剪贴板监听** (预计 1-2 小时)
- [ ] 实现 OnClipboardChange 监听
- [ ] 状态机控制（仅 ACTIVE 时响应）
- [ ] 防抖和防误触逻辑

**阶段 3：配置文件支持** (预计 1-2 小时)
- [ ] 定义 config.json 格式
- [ ] AHK 读取 JSON 配置
- [ ] 热重载配置

**阶段 4：Web 配置界面** (预计 3-4 小时)
- [ ] Flask 后端 API
- [ ] 前端页面 UI
- [ ] 配置保存和读取
- [ ] 服务状态显示

**阶段 5：系统集成** (预计 1-2 小时)
- [ ] 托盘图标和菜单
- [ ] 开机自启动
- [ ] 打包和文档

---

## 5. 验收标准

### 5.1 功能验收

- [ ] 单一快捷键可完成唤起和上屏
- [ ] 剪贴板变化自动触发粘贴（仅输入态）
- [ ] 日常复制操作不受影响
- [ ] Web 界面可修改所有配置项
- [ ] 配置修改后立即生效（或提示重启）
- [ ] 托盘图标可控制启停

### 5.2 体验验收

- [ ] 完整流程只需 1 个快捷键 + 1 次点击
- [ ] 响应延迟 < 500ms
- [ ] 无误触发情况

---

## 6. 风险和注意事项

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| AHK 剪贴板监听性能 | 可能影响系统剪贴板 | 仅 ACTIVE 状态监听 |
| Web 服务端口占用 | 启动失败 | 可配置端口，自动重试 |
| 配置文件损坏 | 功能异常 | 校验 + 自动恢复默认 |
| scrcpy 异常退出 | 状态不同步 | 监听进程，自动重置状态 |

---

## 7. 附录

### 7.1 参考资料

- [AutoHotkey v2 OnClipboardChange](https://www.autohotkey.com/docs/v2/lib/OnClipboardChange.htm)
- [Flask 官方文档](https://flask.palletsprojects.com/)
- [Tailwind CSS](https://tailwindcss.com/)
- [Alpine.js](https://alpinejs.dev/)

### 7.2 修订历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2026-02-02 | 初始版本 |
